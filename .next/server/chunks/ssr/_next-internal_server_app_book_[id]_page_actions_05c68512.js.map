{"version":3,"sources":["../../../../lib/stripe.ts","../../../../app/actions/stripe.ts"],"sourcesContent":["import \"server-only\"\nimport Stripe from \"stripe\"\n\nexport const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!)\n","\"use server\"\n\nimport { stripe } from \"@/lib/stripe\"\nimport { createClient } from \"@/lib/supabase/server\"\n\ninterface CheckoutSessionData {\n  flightId: string\n  seatNumber: string\n  seatClass: \"economy\" | \"business\"\n  passengerName: string\n  passengerEmail: string\n  price: number\n}\n\nexport async function startCheckoutSession(data: CheckoutSessionData) {\n  const supabase = await createClient()\n\n  // Get flight details\n  const { data: flight } = await supabase.from(\"flights\").select(\"*\").eq(\"id\", data.flightId).single()\n\n  if (!flight) {\n    throw new Error(\"Flight not found\")\n  }\n\n  // Generate booking reference\n  const bookingRef = `AI${Date.now().toString(36).toUpperCase()}`\n\n  // Get current user (optional - booking can work without auth)\n  const {\n    data: { user },\n  } = await supabase.auth.getUser()\n\n  // Create checkout session\n  const session = await stripe.checkout.sessions.create({\n    ui_mode: \"embedded\",\n    redirect_on_completion: \"never\",\n    line_items: [\n      {\n        price_data: {\n          currency: \"inr\",\n          product_data: {\n            name: `${flight.flight_number}: ${flight.origin} â†’ ${flight.destination}`,\n            description: `Seat ${data.seatNumber} - ${data.seatClass.charAt(0).toUpperCase() + data.seatClass.slice(1)} Class`,\n          },\n          unit_amount: data.price,\n        },\n        quantity: 1,\n      },\n    ],\n    mode: \"payment\",\n    customer_email: data.passengerEmail,\n    metadata: {\n      flightId: data.flightId,\n      seatNumber: data.seatNumber,\n      seatClass: data.seatClass,\n      passengerName: data.passengerName,\n      passengerEmail: data.passengerEmail,\n      bookingReference: bookingRef,\n      userId: user?.id || \"guest\",\n    },\n  })\n\n  // Create pending booking\n  await supabase.from(\"bookings\").insert({\n    user_id: user?.id || null,\n    flight_id: data.flightId,\n    passenger_name: data.passengerName,\n    passenger_email: data.passengerEmail,\n    seat_number: data.seatNumber,\n    seat_class: data.seatClass,\n    price_paid: data.price,\n    booking_reference: bookingRef,\n    payment_status: \"pending\",\n    stripe_session_id: session.id,\n  })\n\n  // Reserve the seat temporarily\n  await supabase\n    .from(\"seats\")\n    .update({ is_available: false })\n    .eq(\"flight_id\", data.flightId)\n    .eq(\"seat_number\", data.seatNumber)\n\n  return { clientSecret: session.client_secret }\n}\n"],"names":[],"mappings":"wDAAA,EAAA,CAAA,CAAA,MAGO,IAAM,EAAS,GAFtB,AAE0B,CAF1B,EAAA,CAAA,CAAA,KAAA,EAE0B,OAAM,CAAC,QAAQ,GAAG,CAAC,iBAAiB,ECA9D,IAAA,EAAA,EAAA,CAAA,CAAA,OAWO,eAAe,EAAqB,CAAyB,EAClE,IAAM,EAAW,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,IAG7B,CAAE,KAAM,CAAM,CAAE,CAAG,MAAM,EAAS,IAAI,CAAC,WAAW,MAAM,CAAC,KAAK,EAAE,CAAC,KAAM,EAAK,QAAQ,EAAE,MAAM,GAElG,GAAI,CAAC,EACH,MADW,AACL,AAAI,MAAM,oBAIlB,IAAM,EAAa,CAAC,EAAE,EAAE,KAAK,GAAG,GAAG,QAAQ,CAAC,IAAI,WAAW,GAAA,CAAI,CAGzD,CACJ,KAAM,MAAE,CAAI,CAAE,CACf,CAAG,MAAM,EAAS,IAAI,CAAC,OAAO,GAGzB,EAAU,MAAM,EAAO,QAAQ,CAAC,QAAQ,CAAC,MAAM,CAAC,CACpD,QAAS,WACT,uBAAwB,QACxB,WAAY,CACV,CACE,WAAY,CACV,SAAU,MACV,aAAc,CACZ,KAAM,CAAA,EAAG,EAAO,aAAa,CAAC,EAAE,EAAE,EAAO,MAAM,CAAC,GAAG,EAAE,EAAO,WAAW,CAAA,CAAE,CACzE,YAAa,CAAC,KAAK,EAAE,EAAK,UAAU,CAAC,GAAG,EAAE,EAAK,SAAS,CAAC,MAAM,CAAC,GAAG,WAAW,GAAK,EAAK,SAAS,CAAC,KAAK,CAAC,GAAG,MAAM,CAAC,AACpH,EACA,YAAa,EAAK,KAAK,AACzB,EACA,SAAU,CACZ,EACD,CACD,KAAM,UACN,eAAgB,EAAK,cAAc,CACnC,SAAU,CACR,SAAU,EAAK,QAAQ,CACvB,WAAY,EAAK,UAAU,CAC3B,UAAW,EAAK,SAAS,CACzB,cAAe,EAAK,aAAa,CACjC,eAAgB,EAAK,cAAc,CACnC,iBAAkB,EAClB,OAAQ,GAAM,IAAM,OACtB,CACF,GAuBA,OApBA,MAAM,EAAS,IAAI,CAAC,YAAY,MAAM,CAAC,CACrC,QAAS,GAAM,IAAM,KACrB,UAAW,EAAK,QAAQ,CACxB,eAAgB,EAAK,aAAa,CAClC,gBAAiB,EAAK,cAAc,CACpC,YAAa,EAAK,UAAU,CAC5B,WAAY,EAAK,SAAS,CAC1B,WAAY,EAAK,KAAK,CACtB,kBAAmB,EACnB,eAAgB,UAChB,kBAAmB,EAAQ,EAAE,AAC/B,GAGA,MAAM,EACH,IAAI,CAAC,SACL,MAAM,CAAC,CAAE,cAAc,CAAM,GAC7B,EAAE,CAAC,YAAa,EAAK,QAAQ,EAC7B,EAAE,CAAC,cAAe,EAAK,UAAU,EAE7B,CAAE,aAAc,EAAQ,aAAa,AAAC,CAC/C,0CAtEsB,IAAA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA"}