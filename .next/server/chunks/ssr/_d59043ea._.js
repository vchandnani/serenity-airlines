module.exports=[64293,a=>{"use strict";var b=a.i(28184),c=a.i(98310),d=a.i(6331),e=a.i(29355);let f=new d.default(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-11-20.acacia"});async function g(a){let b=await (0,c.createClient)(),d=`AI${Date.now().toString(36).toUpperCase()}${Math.random().toString(36).substring(2,5).toUpperCase()}`,{data:{user:e}}=await b.auth.getUser(),{data:g,error:h}=await b.from("bookings").insert({flight_id:a.flightId,user_id:e?.id||null,passenger_name:a.passengerName,passenger_email:a.passengerEmail,seat_number:a.seatNumber,seat_class:a.seatClass,price_paid:a.price,confirmation_code:d,status:"pending"}).select().single();if(h||!g)return{error:"Failed to create booking"};let{error:i}=await b.from("seats").update({is_available:!1,booking_id:g.id}).eq("flight_id",a.flightId).eq("seat_number",a.seatNumber);if(i)return await b.from("bookings").delete().eq("id",g.id),{error:"Seat no longer available"};let{data:j}=await b.from("flights").select("*").eq("id",a.flightId).single();return{sessionUrl:(await f.checkout.sessions.create({payment_method_types:["card"],line_items:[{price_data:{currency:"usd",product_data:{name:`${j?.flight_number} - ${j?.origin} to ${j?.destination}`,description:`Seat ${a.seatNumber} (${a.seatClass.toUpperCase()})`},unit_amount:Math.round(100*a.price)},quantity:1}],mode:"payment",success_url:`${process.env.NEXT_PUBLIC_SITE_URL||"http://localhost:3000"}/booking-confirmation?booking_id=${g.id}&session_id={CHECKOUT_SESSION_ID}`,cancel_url:`${process.env.NEXT_PUBLIC_SITE_URL||"http://localhost:3000"}/book/${a.flightId}?class=${a.seatClass}`,metadata:{booking_id:g.id,confirmation_code:d}})).url,bookingId:g.id}}async function h(a,b){let d=await (0,c.createClient)(),e=await f.checkout.sessions.retrieve(b);if("paid"===e.payment_status){let{error:b}=await d.from("bookings").update({status:"completed",stripe_payment_id:e.payment_intent}).eq("id",a);if(b)return{error:"Failed to confirm booking"};let{data:c}=await d.from("bookings").select("*, flights(*)").eq("id",a).single();return{booking:c}}return{error:"Payment not completed"}}(0,e.ensureServerEntryExports)([g,h]),(0,b.registerServerReference)(g,"40be073f1f8f32e54ce2fe39ed43b648bc24f01723",null),(0,b.registerServerReference)(h,"607a5747488fbcd34747abb349ab06f712ef29f321",null),a.s(["confirmPayment",()=>h,"createBooking",()=>g])},67248,a=>{"use strict";var b=a.i(64293);a.s([],51138),a.i(51138),a.s(["40be073f1f8f32e54ce2fe39ed43b648bc24f01723",()=>b.createBooking,"607a5747488fbcd34747abb349ab06f712ef29f321",()=>b.confirmPayment],67248)}];

//# sourceMappingURL=_d59043ea._.js.map