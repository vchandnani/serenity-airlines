{"version":3,"sources":["../../../../app/actions/booking.ts","../../../../.next-internal/server/app/booking-confirmation/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["\"use server\"\n\nimport { createClient } from \"@/lib/supabase/server\"\nimport Stripe from \"stripe\"\n\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {\n  apiVersion: \"2024-11-20.acacia\",\n})\n\nexport async function createBooking(formData: {\n  flightId: string\n  seatNumber: string\n  seatClass: \"economy\" | \"business\"\n  passengerName: string\n  passengerEmail: string\n  price: number\n}) {\n  const supabase = await createClient()\n\n  // Generate unique confirmation code\n  const confirmationCode = `AI${Date.now().toString(36).toUpperCase()}${Math.random().toString(36).substring(2, 5).toUpperCase()}`\n\n  // Get authenticated user (optional)\n  const {\n    data: { user },\n  } = await supabase.auth.getUser()\n\n  // Create pending booking\n  const { data: booking, error: bookingError } = await supabase\n    .from(\"bookings\")\n    .insert({\n      flight_id: formData.flightId,\n      user_id: user?.id || null,\n      passenger_name: formData.passengerName,\n      passenger_email: formData.passengerEmail,\n      seat_number: formData.seatNumber,\n      seat_class: formData.seatClass,\n      price_paid: formData.price,\n      confirmation_code: confirmationCode,\n      status: \"pending\",\n    })\n    .select()\n    .single()\n\n  if (bookingError || !booking) {\n    return { error: \"Failed to create booking\" }\n  }\n\n  // Reserve the seat\n  const { error: seatError } = await supabase\n    .from(\"seats\")\n    .update({ is_available: false, booking_id: booking.id })\n    .eq(\"flight_id\", formData.flightId)\n    .eq(\"seat_number\", formData.seatNumber)\n\n  if (seatError) {\n    // Rollback booking if seat reservation fails\n    await supabase.from(\"bookings\").delete().eq(\"id\", booking.id)\n    return { error: \"Seat no longer available\" }\n  }\n\n  // Get flight details for Stripe\n  const { data: flight } = await supabase.from(\"flights\").select(\"*\").eq(\"id\", formData.flightId).single()\n\n  // Create Stripe Checkout Session\n  const session = await stripe.checkout.sessions.create({\n    payment_method_types: [\"card\"],\n    line_items: [\n      {\n        price_data: {\n          currency: \"usd\",\n          product_data: {\n            name: `${flight?.flight_number} - ${flight?.origin} to ${flight?.destination}`,\n            description: `Seat ${formData.seatNumber} (${formData.seatClass.toUpperCase()})`,\n          },\n          unit_amount: Math.round(formData.price * 100),\n        },\n        quantity: 1,\n      },\n    ],\n    mode: \"payment\",\n    success_url: `${process.env.NEXT_PUBLIC_SITE_URL || \"http://localhost:3000\"}/booking-confirmation?booking_id=${booking.id}&session_id={CHECKOUT_SESSION_ID}`,\n    cancel_url: `${process.env.NEXT_PUBLIC_SITE_URL || \"http://localhost:3000\"}/book/${formData.flightId}?class=${formData.seatClass}`,\n    metadata: {\n      booking_id: booking.id,\n      confirmation_code: confirmationCode,\n    },\n  })\n\n  return { sessionUrl: session.url, bookingId: booking.id }\n}\n\nexport async function confirmPayment(bookingId: string, sessionId: string) {\n  const supabase = await createClient()\n\n  // Verify the Stripe session\n  const session = await stripe.checkout.sessions.retrieve(sessionId)\n\n  if (session.payment_status === \"paid\") {\n    // Update booking status\n    const { error } = await supabase\n      .from(\"bookings\")\n      .update({\n        status: \"completed\",\n        stripe_payment_id: session.payment_intent as string,\n      })\n      .eq(\"id\", bookingId)\n\n    if (error) {\n      return { error: \"Failed to confirm booking\" }\n    }\n\n    // Get booking details\n    const { data: booking } = await supabase.from(\"bookings\").select(\"*, flights(*)\").eq(\"id\", bookingId).single()\n\n    return { booking }\n  }\n\n  return { error: \"Payment not completed\" }\n}\n","export {createBooking as '40be073f1f8f32e54ce2fe39ed43b648bc24f01723'} from 'ACTIONS_MODULE0'\nexport {confirmPayment as '607a5747488fbcd34747abb349ab06f712ef29f321'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":"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"}